<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <title>Tienda "La Caserita"</title>
</head>

<link rel="stylesheet" href="Estilos/styles-login.css">

<body>
    <script>
        // Si ya hay una sesi√≥n activa, ir directo al home (Revisa incluso si viene de 'Atr√°s')
        window.onpageshow = function (event) {
            const userRole = localStorage.getItem('userRole') || sessionStorage.getItem('userRole');
            if (userRole) {
                window.location.replace('home.html');
            }
        };
    </script>
    <div class="container">
        <div class="left-panel">
            <div class="logo">
                <img src="Imagenes/logo.png" alt="logo-tienda">
            </div>
            <h1 class="brand-title">Tienda "La Caserita"</h1>
            <p class="brand-subtitle">Tu tienda de confianza, ahora en l√≠nea. Productos frescos para tu hogar.</p>
        </div>

        <div class="right-panel">
            <div class="login-card">
                <h2 class="titulo">¬°BIENVENIDO DE NUEVO!</h2>
                <p class="subtitulo">Ingrese sus datos para continuar</p>

                <!-- Formulario de LOGIN -->
                <div id="loginSection">
                    <form id="loginForm">
                        <div class="grupo">
                            <label class="label">Correo Electr√≥nico</label>
                            <div class="input-wrapper">
                                <span class="input-icon">‚úâ</span>
                                <input type="email" id="email" placeholder="tu@email.com">
                            </div>
                            <span class="error-message" id="email-error"></span>
                        </div>

                        <div class="grupo">
                            <label class="label">Contrase√±a</label>
                            <div class="input-wrapper">
                                <span class="input-icon">üîí</span>
                                <input type="password" id="password" placeholder="Ingrese su contrase√±a">
                                <button type="button" class="password-toggle"
                                    onclick="togglePass('password')">üëÅ</button>
                            </div>
                            <span class="error-message" id="password-error"></span>
                        </div>

                        <div class="remember-forgot">
                            <label class="remember-me">
                                <input type="checkbox" id="rememberMe"> <span>Recordarme</span>
                            </label>
                            <a href="#" onclick="showForgot()" class="forgot-password">¬øOlvidaste contrase√±a?</a>
                        </div>

                        <button type="submit" class="login-button">INICIAR SESI√ìN</button>
                    </form>

                    <div class="divider"><span>O contin√∫a con</span></div>

                    <div style="display: flex; justify-content: center; margin-top: 15px;">
                        <div id="g_id_onload"
                            data-client_id="589528567916-hvlebsdnr1goao5d8dscg2kjk8u41qt8.apps.googleusercontent.com"
                            data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"
                            data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <p>¬øNo tienes cuenta? <a href="#" onclick="showRegister()"
                                style="color: #059669; font-weight: bold;">Reg√≠strate aqu√≠</a></p>
                    </div>
                </div>

                <!-- Formulario de REGISTRO (Oculto) -->
                <div id="registerSection" style="display: none;">
                    <h2 class="titulo">CREAR CUENTA</h2>
                    <p class="subtitulo">√önete a La Caserita hoy mismo</p>

                    <form id="registerForm">
                        <div class="grupo">
                            <label class="label">Nombre Completo</label>
                            <div class="input-wrapper">
                                <span class="input-icon">üë§</span>
                                <input type="text" id="regNombre" placeholder="Tu Nombre" required>
                            </div>
                        </div>

                        <div class="grupo">
                            <label class="label">Correo Electr√≥nico</label>
                            <div class="input-wrapper">
                                <span class="input-icon">‚úâ</span>
                                <input type="email" id="regEmail" placeholder="tu@email.com" required>
                            </div>
                        </div>

                        <div class="grupo">
                            <label class="label">Contrase√±a</label>
                            <div class="input-wrapper">
                                <span class="input-icon">üîí</span>
                                <input type="password" id="regPassword" placeholder="Crea una contrase√±a" required>
                                <button type="button" class="password-toggle"
                                    onclick="togglePass('regPassword')">üëÅ</button>
                            </div>
                        </div>

                        <div class="grupo">
                            <label class="label">Confirmar Contrase√±a</label>
                            <div class="input-wrapper">
                                <span class="input-icon">üîí</span>
                                <input type="password" id="regConfirmPassword" placeholder="Repite la contrase√±a"
                                    required>
                                <button type="button" class="password-toggle"
                                    onclick="togglePass('regConfirmPassword')">üëÅ</button>
                            </div>
                            <span class="error-message" id="match-error" style="color:red; font-size:12px;"></span>
                        </div>

                        <button type="submit" class="login-button">REGISTRARSE</button>
                    </form>

                    <div style="margin-top: 20px; text-align: center;">
                        <p>¬øYa tienes cuenta? <a href="#" onclick="showLogin()"
                                style="color: #0d5f6e; font-weight: bold;">Inicia Sesi√≥n</a></p>
                    </div>
                </div>

                <!-- Formulario de VERIFICACI√ìN (Oculto) -->
                <div id="verificationSection" style="display: none; text-align: center;">
                    <h2 class="titulo">VERIFICAR CUENTA</h2>
                    <p class="subtitulo">Ingresa el c√≥digo que enviamos a tu correo</p>
                    <div style="margin-bottom: 20px;">
                        <span style="font-size: 40px;">üì©</span>
                    </div>

                    <form id="verifyForm">
                        <div class="grupo">
                            <label class="label" style="text-align: center;">C√≥digo de 6 d√≠gitos</label>
                            <div class="input-wrapper">
                                <input type="text" id="verifyCode" placeholder="000000" maxlength="6"
                                    style="text-align: center; letter-spacing: 5px; font-size: 20px;" required>
                            </div>
                        </div>
                        <button type="submit" class="login-button">VERIFICAR Y ENTRAR</button>
                    </form>
                    <div style="margin-top: 20px;">
                        <a href="#" onclick="showLogin()" style="color: #666;">Volver al inicio</a>
                    </div>
                </div>

                <!-- Formulario OLVID√â PASSWORD - PASO 1 (Email) -->
                <div id="forgotSection" style="display: none; text-align: center;">
                    <h2 class="titulo">RECUPERAR CUENTA</h2>
                    <p class="subtitulo">Ingresa tu correo para recibir un c√≥digo</p>

                    <form id="forgotForm">
                        <div class="grupo">
                            <label class="label">Correo Electr√≥nico</label>
                            <div class="input-wrapper">
                                <span class="input-icon">‚úâ</span>
                                <input type="email" id="forgotEmail" placeholder="tu@email.com" required>
                            </div>
                        </div>
                        <button type="submit" class="login-button">ENVIAR C√ìDIGO</button>
                    </form>
                    <div style="margin-top: 20px;">
                        <a href="#" onclick="showLogin()" style="color: #666;">Cancelar</a>
                    </div>
                </div>

                <!-- Formulario OLVID√â PASSWORD - PASO 2 (Validar C√≥digo) -->
                <div id="codeValidSection" style="display: none;">
                    <h2 class="titulo">C√ìDIGO DE SEGURIDAD</h2>
                    <p class="subtitulo">Ingresa el c√≥digo enviado a tu correo</p>

                    <form id="codeForm">
                        <div class="grupo">
                            <label class="label">C√≥digo de 6 d√≠gitos</label>
                            <div class="input-wrapper">
                                <input type="text" id="validCode" placeholder="000000" maxlength="6"
                                    style="text-align: center; letter-spacing: 5px; font-size: 20px;" required>
                            </div>
                        </div>
                        <button type="submit" class="login-button">VERIFICAR C√ìDIGO</button>
                    </form>
                    <div style="margin-top: 20px; text-align: center;">
                        <a href="#" onclick="showForgot()" style="color: #666;">Reenviar correo</a>
                    </div>
                </div>

                <!-- Formulario OLVID√â PASSWORD - PASO 3 (Nueva Password) -->
                <div id="newPassSection" style="display: none;">
                    <h2 class="titulo">NUEVA CONTRASE√ëA</h2>
                    <p class="subtitulo">Crea una nueva contrase√±a segura</p>

                    <form id="finalResetForm">
                        <div class="grupo">
                            <label class="label">Nueva Contrase√±a</label>
                            <div class="input-wrapper">
                                <span class="input-icon">üîí</span>
                                <input type="password" id="newPassword" placeholder="Nueva contrase√±a" required>
                                <button type="button" class="password-toggle"
                                    onclick="togglePass('newPassword')">üëÅ</button>
                            </div>
                        </div>

                        <div class="grupo">
                            <label class="label">Confirmar Nueva Contrase√±a</label>
                            <div class="input-wrapper">
                                <span class="input-icon">üîí</span>
                                <input type="password" id="confirmNewPassword" placeholder="Repite password" required>
                                <button type="button" class="password-toggle"
                                    onclick="togglePass('confirmNewPassword')">üëÅ</button>
                            </div>
                            <span class="error-message" id="reset-match-error"
                                style="color:red; font-size:12px;"></span>
                        </div>

                        <button type="submit" class="login-button">CAMBIAR CONTRASE√ëA</button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="custom-modal">
            <span class="modal-icon" id="modalIcon">‚ö†Ô∏è</span>
            <h3 class="modal-title" id="modalTitle">Mensaje</h3>
            <p class="modal-message" id="modalMessage">Descripci√≥n del mensaje</p>
            <button class="modal-btn" id="modalBtn" onclick="closeModal()">Entendido</button>
        </div>
    </div>

    <!-- Branded Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <img src="Imagenes/logo.png" class="loading-logo" alt="Cargando...">
        </div>
        <h3 class="loading-text" id="loadingText">Cargando...</h3>
        <p class="loading-subtext" id="loadingSubtext">Por favor espere</p>
    </div>

    <script>
        const API_URL = 'https://tienda-caserita-api.onrender.com/api/auth';
        let registeredEmail = ''; // Para verificaci√≥n registro
        let recoveryEmail = '';   // Para recuperaci√≥n pass
        let recoveryCode = '';    // C√≥digo validado

        // --- MANEJO DE VISTAS ---
        function hideAll() {
            $('#loginSection, #registerSection, #verificationSection, #forgotSection, #codeValidSection, #newPassSection').hide();
        }

        function showLogin() { hideAll(); $('#loginSection').fadeIn(); }
        function showRegister() { hideAll(); $('#registerSection').fadeIn(); }
        function showForgot() { hideAll(); $('#forgotSection').fadeIn(); }

        function showVerification(email) {
            registeredEmail = email;
            hideAll();
            $('#verificationSection').fadeIn();
        }

        function showCodeValid(email) {
            recoveryEmail = email;
            hideAll();
            $('#codeValidSection').fadeIn();
        }

        function showNewPass() {
            hideAll();
            $('#newPassSection').fadeIn();
        }

        function togglePass(id) {
            const $input = $('#' + id);
            $input.attr('type', $input.attr('type') === 'password' ? 'text' : 'password');
        }

        // --- ALERTAS ---
        function showAlert(icon, title, message, type = 'normal') {
            $('#modalIcon').text(icon);
            $('#modalTitle').text(title);
            $('#modalMessage').text(message);
            const $btn = $('#modalBtn');
            $btn.removeClass('error success');
            if (type === 'error') $btn.addClass('error');
            if (type === 'success') $btn.addClass('success');
            $('#modalOverlay').addClass('active');
        }
        function closeModal() { $('#modalOverlay').removeClass('active'); }

        // --- LOADING --- (Para esperas de Render)
        function showLoading(msg = 'Iniciando sesi√≥n...') {
            $('#loadingText').text(msg);

            // Mensaje personalizado para el "cold start" de Render
            if (msg.includes('Iniciando') || msg.includes('Verificando')) {
                $('#loadingSubtext').text('Conectando con el servidor seguro...');
            } else {
                $('#loadingSubtext').text('Por favor espere un momento');
            }

            $('#loadingOverlay').addClass('active');
        }

        function hideLoading() {
            $('#loadingOverlay').removeClass('active');
        }

        // --- LOGICA ---
        $(document).ready(function () {
            const savedToken = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (savedToken) { /* Auto-login check opcional */ }

            // Validaciones Visuales
            $('#regPassword, #regConfirmPassword').on('keyup', checkMatchRegister);
            $('#newPassword, #confirmNewPassword').on('keyup', checkMatchReset);

            function checkMatchRegister() {
                const p1 = $('#regPassword').val();
                const p2 = $('#regConfirmPassword').val();
                if (p1 && p2) {
                    if (p1 === p2) {
                        $('#regConfirmPassword').addClass('success').removeClass('error');
                        $('#match-error').text('');
                    } else {
                        $('#regConfirmPassword').addClass('error').removeClass('success');
                        $('#match-error').text('No coinciden');
                    }
                }
            }

            function checkMatchReset() {
                const p1 = $('#newPassword').val();
                const p2 = $('#confirmNewPassword').val();
                if (p1 && p2) {
                    if (p1 === p2) {
                        $('#confirmNewPassword').addClass('success').removeClass('error');
                        $('#reset-match-error').text('');
                    } else {
                        $('#confirmNewPassword').addClass('error').removeClass('success');
                        $('#reset-match-error').text('No coinciden');
                    }
                }
            }

            // LOGIN
            $('#loginForm').on('submit', async function (e) {
                e.preventDefault();
                showLoading('Entrando a tu cuenta...'); // <--- LOADING
                const email = $('#email').val().trim();
                const password = $('#password').val().trim();
                const remember = $('#rememberMe').is(':checked');

                try {
                    const res = await fetch(`${API_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();

                    hideLoading(); // <--- Ocultar al terminar

                    if (res.ok) {
                        processLogin(data, remember);
                    } else {
                        if (data.error === "Usuario no encontrado") {
                            showAlert('üë§', 'No existe', 'Registrate primero.', 'normal');
                            showRegister();
                            $('#regEmail').val(email);
                        } else if (data.error.includes("no verificada")) {
                            showVerification(email);
                            showAlert('üì©', 'Verifica tu cuenta', 'Ingresa el c√≥digo que te enviamos.');
                        } else {
                            showAlert('‚ö†Ô∏è', 'Error', data.error, 'error');
                        }
                    }
                } catch (err) {
                    hideLoading();
                    showAlert('üîå', 'Error', 'Fallo de conexi√≥n');
                }
            });

            // REGISTER
            $('#registerForm').on('submit', async function (e) {
                e.preventDefault();
                const nombre = $('#regNombre').val().trim();
                const email = $('#regEmail').val().trim();
                const password = $('#regPassword').val().trim();

                try {
                    const res = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nombre, email, password })
                    });
                    const d = await res.json();
                    if (res.ok) {
                        showAlert('üìß', 'C√≥digo Enviado', 'Revisa tu correo.');
                        showVerification(email);
                    } else {
                        showAlert('‚ö†Ô∏è', 'Error', d.error, 'error');
                    }
                } catch (e) { showAlert('üîå', 'Error', 'Error de red'); }
            });

            // VERIFY REGISTRO
            $('#verifyForm').on('submit', async function (e) {
                e.preventDefault();
                const codigo = $('#verifyCode').val().trim();
                try {
                    const res = await fetch(`${API_URL}/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: registeredEmail, codigo })
                    });
                    const d = await res.json();
                    if (res.ok) {
                        showAlert('√âxito', 'Cuenta verificada.', 'success');
                        setTimeout(() => processLogin(d, true), 1500);
                    } else showAlert('‚ùå', 'Error', d.error, 'error');
                } catch (e) { showAlert('üîå', 'Error', 'Error de red'); }
            });

            // PASSWORD RECOVERY STEP 1: SEND CODE
            $('#forgotForm').on('submit', async function (e) {
                e.preventDefault();
                const email = $('#forgotEmail').val().trim();
                try {
                    const res = await fetch(`${API_URL}/forgot-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const d = await res.json();
                    if (res.ok) {
                        showAlert('üìß', 'C√≥digo Enviado', 'Revisa tu correo.', 'success');
                        showCodeValid(email);
                    } else showAlert('‚ö†Ô∏è', 'Error', d.error, 'error');
                } catch (e) { showAlert('üîå', 'Error', 'Error de red'); }
            });

            // PASSWORD RECOVERY STEP 2: VERIFY CODE
            $('#codeForm').on('submit', async function (e) {
                e.preventDefault();
                const codigo = $('#validCode').val().trim();
                try {
                    const res = await fetch(`${API_URL}/verify-code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: recoveryEmail, codigo })
                    });
                    const d = await res.json();
                    if (res.ok) {
                        recoveryCode = codigo; // Guardar c√≥digo para paso final
                        showAlert('‚úÖ', 'C√≥digo Correcto', 'Ahora crea tu nueva contrase√±a.', 'success');
                        showNewPass();
                    } else showAlert('‚ùå', 'Error', d.error, 'error');
                } catch (e) { showAlert('üîå', 'Error', 'Error de red'); }
            });

            // PASSWORD RECOVERY STEP 3: RESET PASS
            $('#finalResetForm').on('submit', async function (e) {
                e.preventDefault();
                const newPassword = $('#newPassword').val().trim();
                const confirm = $('#confirmNewPassword').val().trim();

                if (newPassword !== confirm) {
                    showAlert('üöß', 'Error', 'Las contrase√±as no coinciden.', 'error');
                    return;
                }

                try {
                    const res = await fetch(`${API_URL}/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: recoveryEmail, codigo: recoveryCode, newPassword })
                    });
                    const d = await res.json();

                    if (res.ok) {
                        showAlert('üéâ', 'Contrase√±a Actualizada', 'Ya puedes iniciar sesi√≥n con tu nueva clave.', 'success');
                        showLogin();
                    } else {
                        showAlert('‚ùå', 'Error', d.error, 'error');
                    }
                } catch (e) { showAlert('üîå', 'Error', 'Error de red'); }
            });
        });

        function processLogin(data, remember) {
            const storage = remember ? localStorage : sessionStorage;
            if (remember) sessionStorage.clear(); else localStorage.clear();

            storage.setItem('token', data.token);
            storage.setItem('usuario', JSON.stringify(data.usuario));

            if (data.usuario.rol === 'admin') storage.setItem('userRole', 'admin');
            else storage.setItem('userRole', 'cliente');

            // USAR REPLACE para que no se pueda volver al login con "Atr√°s"
            window.location.replace('home.html');
        }

        // GOOGLE CALLBACK
        function handleCredentialResponse(response) {
            showLoading('Verificando con Google...'); // Mostrar carga

            fetch(`${API_URL}/google`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: response.credential })
            })
                .then(res => res.json())
                .then(data => {
                    hideLoading(); // Ocultar carga
                    if (data.token) processLogin(data, true);
                    else showAlert('‚ùå', 'Error', 'Fallo Google Auth');
                })
                .catch(err => {
                    hideLoading();
                    showAlert('üîå', 'Error', 'No se pudo conectar al servidor.');
                });
        }
    </script>
</body>

</html>